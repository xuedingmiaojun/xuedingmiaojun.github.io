(window.webpackJsonp=window.webpackJsonp||[]).push([[237],{525:function(t,a,s){"use strict";s.r(a);var n=s(2),r=Object(n.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("分享如何使用云函数来实现办公文件预览"),s("br")]),t._v(" "),s("h3",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("曾几何时，文档预览曾经很麻烦，小公司需要购买服务器，自行搭建文件服务器来满足产品的文件预览需求，用户上传的文件经由后端进行转码之后才能预览，技术团队需要搭建文件存储服务及转码服务才能实现基础功能，我司就是这么做的。")]),t._v(" "),s("p",[t._v("虽然有公开的微软office预览服务以及kkfileview等实现方案，但仍然存在诸多问题，比如微软office预览的大小限制，kk的略微繁重。")]),t._v(" "),s("p",[t._v("难道如果我只是想要一个轻量级的文档服务就那么难吗？No、No、No，之前一直在关注腾讯云云函数，也在不停基于云函数探索有意思的功能来满足平时的开发需求，前段时间正好公司项目需要用到金山的服务做文件预览，使用效果还可以，那么灵感来了，为什么不能将两个大佬的能力结合一下？说干就干，腾讯云云函数和金山的文档的整合，我看行。")]),t._v(" "),s("h3",{attrs:{id:"探讨可行性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#探讨可行性","aria-hidden":"true"}},[t._v("#")]),t._v(" 探讨可行性")]),t._v(" "),s("p",[t._v("首先问题的关键在于通过后端服务去获取预览地址并通过一个网页去承载金山的预览服务，幸运的是这些都可以通过云函数做到，首先云函数是支持nodeJS编写的，所以我们只要使用nodejs去请求金山的接口获取预览地址，然后通过设置函数返回类型为网页就可以将预览地址嵌入函数返回的iframe中来实现预览功能，是不是很简单易用。")]),t._v(" "),s("p",[t._v("talk is cheap,show me the code.下面我们来践行一下吧~")]),t._v(" "),s("h3",{attrs:{id:"云函数编写"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#云函数编写","aria-hidden":"true"}},[t._v("#")]),t._v(" 云函数编写")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'use strict'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'request-promise'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" officeBaseUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'私有服务端?fileUrl='")]),t._v("\nexports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("main")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" fileUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://默认下载的预览文件地址.doc'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" param "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queryStringParameters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        param "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("queryStringParameters "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        param "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("event "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("param"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        fileUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" param"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" previewRes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("rp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" officeBaseUrl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" fileUrl "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    previewRes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("previewRes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        statusCode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        headers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"content-type"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text/html"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('`<script>location.replace("')]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("previewRes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("wpsUrl"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('");<\/script>`')])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"问题记录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#问题记录","aria-hidden":"true"}},[t._v("#")]),t._v(" 问题记录")]),t._v(" "),s("p",[t._v("细心的同学会发现在云函数返回体部分在这里写的是一段js代码重定向到了一个url。这里之所以没有使用iframe去嵌入预览地址是因为会报获取token失败的错误，所以退而求其次采取了直接跳转到预览地址的方式来查看文件。")]),t._v(" "),s("h3",{attrs:{id:"体验地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#体验地址","aria-hidden":"true"}},[t._v("#")]),t._v(" 体验地址")]),t._v(" "),s("p",[s("a",{attrs:{href:"http://tcb.xuedingmiao.com/office_preview",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://tcb.xuedingmiao.com/office_preview"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"演示效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#演示效果","aria-hidden":"true"}},[t._v("#")]),t._v(" 演示效果")]),t._v(" "),s("iframe",{attrs:{src:"//player.bilibili.com/player.html?aid=887398894&bvid=BV1rK4y1N7S2&cid=318824772&page=1",scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"true",width:"100%",height:"300px"}}),t._v(" "),s("h3",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://cloud.tencent.com/document/product/876/41776",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用集成响应返回 HTML"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://wwo.wps.cn/docs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("金山文档在线预览编辑服务"),s("OutboundLink")],1)])])])},[],!1,null,null,null);a.default=r.exports}}]);