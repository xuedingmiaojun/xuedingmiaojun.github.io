(window.webpackJsonp=window.webpackJsonp||[]).push([[147],{432:function(t,e,a){"use strict";a.r(e);var n=a(2),s=Object(n.a)({},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("分享一个bug的处理方法"),a("br")]),t._v(" "),a("h3",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景","aria-hidden":"true"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),a("p",[t._v("最近使用uni-app开发项目时遇到了一个bug，需求是需要在两个平台之间切换，A平台登录后要选择身份，选完后带着token进入另外一个平台B的个人空间，点击个人空间顶部的个人信息区域又可以切换到A平台的身份选择。"),a("br"),t._v("\n这样子就产生了一个问题，点击身份的时候会生成新的token，但是页面是允许返回的所以url地址栏中的历史token还在，所以就会基于这个token触发请求导致接口报了Token验证失败的错误，一番搜索之后终于找到了解决办法。")]),t._v(" "),a("h3",{attrs:{id:"解决方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方法","aria-hidden":"true"}},[t._v("#")]),t._v(" 解决方法")]),t._v(" "),a("p",[t._v("利用浏览器的window.performance.navigation.type属性")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("window.performance.navigation.type\n")])])]),a("p",[t._v("window.performance是W3C性能小组引入的新的API，目前IE9以上的浏览器都支持。"),a("br"),t._v("\n我们可以在官方说明中找到PerformanceNavigation接口的详细介绍：")]),t._v(" "),a("div",{staticClass:"language-C extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Exposed"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\ninterface PerformanceNavigation "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v(" TYPE_NAVIGATE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v(" TYPE_RELOAD "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v(" TYPE_BACK_FORWARD "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v(" TYPE_RESERVED "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  readonly attribute "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  readonly attribute "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("short")]),t._v(" redirectCount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" object "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toJSON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("type 属性返回值为0,1,2。分别对应三个枚举值:")]),t._v(" "),a("ul",[a("li",[t._v("0 : TYPE_NAVIGATE\n"),a("ul",[a("li",[t._v('Navigation where the history handling behavior is set to "default" or "replace".(用户通过常规导航方式访问页面，比如点一个链接，或者一般的get方式)')])])]),t._v(" "),a("li",[t._v("1 : TYPE_RELOAD\n"),a("ul",[a("li",[t._v('Navigation where the history handling behavior is set to "reload".(用户通过刷新，包括JS调用刷新接口等方式访问页面)')])])]),t._v(" "),a("li",[t._v("2 : TYPE_BACK_FORWARD\n"),a("ul",[a("li",[t._v('Navigation where the history handling behavior is set to "entry update".(用户通过后退按钮访问本页面)')])])]),t._v(" "),a("li",[t._v("255 : TYPE_RESERVED\n"),a("ul",[a("li",[t._v("Any navigation types not defined by values above.(上面的值未定义的任何导航类型)")])])]),t._v(" "),a("li",[t._v("type\n"),a("ul",[a("li",[t._v("This attribute must return the type of the last non-redirect navigation in the current browsing context. It must have one of the following navigation type values.")])]),t._v(" "),a("blockquote",[a("p",[t._v("NOTE"),a("br"),t._v("\nClient-side redirects, such as those using the Refresh pragma directive, are not considered HTTP redirects by this spec. In those cases, the type attribute should return appropriate value, such as TYPE_RELOAD if reloading the current page, or TYPE_NAVIGATE if navigating to a new URL.(客户端重定向，例如使用Refresh pragma伪指令的客户端重定向，在本规范中不视为HTTP重定向。在这些情况下，该type 属性应返回适当的值，例如 TYPE_RELOAD重新加载当前页面或 TYPE_NAVIGATE导航到新URL)")])])]),t._v(" "),a("li",[t._v("redirectCount\n"),a("ul",[a("li",[t._v("This attribute must return the number of redirects since the last non-redirect navigation under the current browsing context. If there is no redirect or there is any redirect that is not from the same origin as the destination document, this attribute must return zero.")])])]),t._v(" "),a("li",[t._v("toJSON()\n"),a("ul",[a("li",[t._v("Runs [WEBIDL]'s default toJSON operation.")])])])]),t._v(" "),a("p",[t._v("所以我们只要判断type属性为2时就可以知道页面是通过返回按钮打开的了，然后开头的问题就可以据此加判断来解决token异常了。")]),t._v(" "),a("p",[a("a",{attrs:{"data-fancybox":"",title:"performance.navigation",href:"http://cdn.xuedingmiao.com/performance.navigation.png"}},[a("img",{staticStyle:{width:"100%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/performance.navigation.png"}})])]),t._v(" "),a("h3",{attrs:{id:"适用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#适用场景","aria-hidden":"true"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),a("p",[t._v("如果在做基于vue等框架开发的前端项目、uni-app来开发h5相关项目时都可以参考上述方法去实现功能")]),t._v(" "),a("h3",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.w3.org/TR/navigation-timing-2/#the-performancenavigation-interface",target:"_blank",rel:"noopener noreferrer"}},[t._v("the-performancenavigation-interface"),a("OutboundLink")],1),t._v("：")])])])},[],!1,null,null,null);e.default=s.exports}}]);