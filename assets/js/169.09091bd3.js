(window.webpackJsonp=window.webpackJsonp||[]).push([[169],{456:function(t,a,v){"use strict";v.r(a);var s=v(2),_=Object(s.a)({},function(){var t=this,a=t.$createElement,v=t._self._c||a;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("p",[t._v("借负责的小程序流量暴增事件总结下优化技巧"),v("br")]),t._v(" "),v("p",[t._v("之前负责的"),v("a",{attrs:{"data-fancybox":"",title:"锡慧在线小程序",href:"/images/xhzx_xcx.jpg"}},[t._v("锡慧在线小程序")]),t._v("是一款公益性质在线教育类小程序，因疫情影响导致流量暴增，日访问过百万"),v("br"),t._v(" "),v("a",{attrs:{"data-fancybox":"",title:"小程序访问统计",href:"/images/20200201totalvisit.png"}},[v("img",{staticStyle:{width:"80%",display:"block"},attrs:{src:"/images/20200201totalvisit.png"}})])]),t._v(" "),v("p",[v("a",{attrs:{"data-fancybox":"",title:"小程序访问统计",href:"/images/20200208totalvisit.png"}},[v("img",{staticStyle:{width:"80%",display:"block"},attrs:{src:"/images/20200208totalvisit.png"}})]),v("br"),t._v("\n高峰期每分钟1w+在线访问"),v("br"),t._v(" "),v("a",{attrs:{"data-fancybox":"",title:"访问高峰",href:"/images/min-total.png"}},[v("img",{staticStyle:{width:"80%",display:"block"},attrs:{src:"/images/min-total.png"}})]),v("br"),t._v("\n视频播放卡顿严重，使用体验很差。"),v("br"),t._v("\n博主已是离职状态，但是公司内并没有找到可以接手的同学，小程序前端是我从零一手做出来的，有点特殊情感，于是就以小程序顾问的身份帮忙处理了小程序端的工作。")]),t._v(" "),v("p",[t._v("应对本次问题，视频卡顿是选择把视频课件资源从文件服务器上迁移至腾讯云存储，现已经修复发版完毕"),v("br"),t._v(" "),v("a",{attrs:{"data-fancybox":"",title:"小程序发版本",href:"/images/xcxversion.png"}},[v("img",{staticStyle:{width:"50%",display:"block"},attrs:{src:"/images/xcxversion.png"}})]),v("br"),t._v("\n在此总结下小程序优化相关知识。")]),t._v(" "),v("h2",{attrs:{id:"小程序端"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#小程序端","aria-hidden":"true"}},[t._v("#")]),t._v(" 小程序端")]),t._v(" "),v("h3",{attrs:{id:"提高加载性能"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#提高加载性能","aria-hidden":"true"}},[t._v("#")]),t._v(" 提高加载性能")]),t._v(" "),v("p",[t._v("小程序呈现到用户面前，实际上经历了下面两个阶段：")]),t._v(" "),v("ul",[v("li",[t._v("运行环境的预加载\n"),v("ul",[v("li",[t._v("微信会在用户打开小程序之前就已经准备好环境，用户点击小程序入口后，直接下载小程序的代码包即可")])])]),t._v(" "),v("li",[t._v("下载代码包启动小程序\n"),v("ul",[v("li",[t._v("小程序代码包里面的代码，不是小程序的源代码，而是编译、压缩、打包之后的代码包")])])])]),t._v(" "),v("p",[v("a",{attrs:{"data-fancybox":"",title:"小程序加载过程",href:"/images/xcxload.jpg"}},[v("img",{staticStyle:{width:"100%",display:"block"},attrs:{src:"/images/xcxload.jpg"}})]),v("br"),t._v("\n小程序提供的运行环境，分为逻辑层（AppService）和 视图层（webView），逻辑层是执行javascript的地方，视图层是渲染页面的地方。当小程序的代码包下载完毕后，业务代码分别注入逻辑层和渲染层。")]),t._v(" "),v("h3",{attrs:{id:"优化关键点"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#优化关键点","aria-hidden":"true"}},[t._v("#")]),t._v(" 优化关键点")]),t._v(" "),v("p",[t._v("控制小程序包的大小")]),t._v(" "),v("ul",[v("li",[t._v("代码级优化\n"),v("ul",[v("li",[t._v("压缩代码")]),t._v(" "),v("li",[t._v("清理无用的代码(含注释掉的代码、log等)")]),t._v(" "),v("li",[t._v("业务级优化，逻辑复用，组件复用")])])]),t._v(" "),v("li",[t._v("图片优化\n"),v("ul",[v("li",[t._v("放CDN")]),t._v(" "),v("li",[t._v("选用其它静态存储服务器")]),t._v(" "),v("li",[t._v("最其次使用优化过大小后的本地图片")])])]),t._v(" "),v("li",[t._v("采用分包策略\n"),v("ul",[v("li",[t._v("分包预加载")]),t._v(" "),v("li",[t._v("独立分包")])])])]),t._v(" "),v("p",[t._v("异步请求优化")]),t._v(" "),v("ul",[v("li",[t._v("onLoad阶段就可发起请求")]),t._v(" "),v("li",[t._v("实时性要求不高的或者非频繁变动的业务数据尽量不要在onShow时请求")]),t._v(" "),v("li",[t._v("请求结果放在缓存中、利用时间戳控制有效期，减少更新次数")]),t._v(" "),v("li",[t._v("核心页面在请求过程中添加骨架屏展示处理")]),t._v(" "),v("li",[t._v("细节体验处理，及时给予用户反馈\n"),v("ul",[v("li",[t._v("如点击按钮后先改变样式(切换启停用状态)，再发出请求，防止用户多次请求")])])])]),t._v(" "),v("h3",{attrs:{id:"提高渲染性能"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#提高渲染性能","aria-hidden":"true"}},[t._v("#")]),t._v(" 提高渲染性能")]),t._v(" "),v("p",[t._v("setData操作优化")]),t._v(" "),v("ul",[v("li",[t._v("减少setData的数据量")]),t._v(" "),v("li",[t._v("不影响渲染层的数据不用放在setData")]),t._v(" "),v("li",[t._v("合并精简setData")]),t._v(" "),v("li",[t._v("避免列表数据全局刷新、局部更新单条数据")])]),t._v(" "),v("div",{staticClass:"language-js extra-class"},[v("pre",{pre:!0,attrs:{class:"language-js"}},[v("code",[t._v("\n"),v("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),v("span",{pre:!0,attrs:{class:"token function"}},[t._v("setData")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  list"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" newList"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),v("p",[t._v("定时器及时销毁")]),t._v(" "),v("ul",[v("li",[t._v("小程序多个页面会多开webview，独立线程运行，当离开页面存在定时器时需要及时销毁")])]),t._v(" "),v("p",[t._v("谨慎使用onPageScroll，该事件是一次webview层向js逻辑层的通讯，开销较大")]),t._v(" "),v("ul",[v("li",[t._v("只在必要时监听pageScroll")]),t._v(" "),v("li",[t._v("onPageScroll中避免执行复杂逻辑，频繁setData，查询节点信息")])]),t._v(" "),v("p",[t._v("善用小程序组件"),v("br"),t._v("\n自定义组件更新只在组件内部进行，不受页面其他内容影响")]),t._v(" "),v("ul",[v("li",[t._v("运营活动的定时模块可以单独抽出来，做成一个定时组件，定时组件的更新并不会影响页面上其他元素的更新；")]),t._v(" "),v("li",[t._v("各个组件具有各自独立的逻辑空间，分别拥有自己的独立的数据、setData调用")])]),t._v(" "),v("p",[t._v("canvas渲染")]),t._v(" "),v("ul",[v("li",[t._v("分层绘制到不同canvas")]),t._v(" "),v("li",[t._v("不变的部分单独绘制到一个canvas")]),t._v(" "),v("li",[t._v("动态生成的绘制到一个canvs")])]),t._v(" "),v("p",[t._v("前端数据过滤")]),t._v(" "),v("ul",[v("li",[t._v("前端数据过滤及验证，不规范的数据不必发送请求增加服务端压力")])]),t._v(" "),v("p",[v("strong",[t._v("开发者工具提供的环境与真机不同，建议真机调试")])]),t._v(" "),v("h2",{attrs:{id:"服务端"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#服务端","aria-hidden":"true"}},[t._v("#")]),t._v(" 服务端")]),t._v(" "),v("p",[t._v("硬件升级")]),t._v(" "),v("ul",[v("li",[t._v("服务器负载均衡")]),t._v(" "),v("li",[t._v("云数据库多台主从读写分离")]),t._v(" "),v("li",[t._v("redis缓存")]),t._v(" "),v("li",[t._v("小程序静态资源使用CDN和OSS文件存储")])]),t._v(" "),v("p",[t._v("分析瓶颈")]),t._v(" "),v("ul",[v("li",[t._v("数据库适当索引加持")]),t._v(" "),v("li",[t._v("找出导致瓶颈的关键业务，如密集计算需求，数据库读写")])]),t._v(" "),v("p",[t._v("redis缓存")]),t._v(" "),v("ul",[v("li",[t._v("写入数据时数据库和redis中都写入，优先查询redis的数据，没有再从数据库读取")]),t._v(" "),v("li",[t._v("进行接口缓存，直接缓存接口返回的json数据，用户再次查相同的内容，直接返回json数据")])]),t._v(" "),v("p",[t._v("负载均衡"),v("br"),t._v("\n将流量分发到不同的服务器上进行处理，减轻对cpu的压力")]),t._v(" "),v("p",[v("strong",[t._v("服务端建议尝试云开发，有腾讯云的基础服务加持也是可以支撑起百万级访问的")])]),t._v(" "),v("p",[t._v("先总结这么多，如果您有更多方法，欢迎补充😄")]),t._v(" "),v("h3",{attrs:{id:"访问数据截图"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#访问数据截图","aria-hidden":"true"}},[t._v("#")]),t._v(" 访问数据截图")]),t._v(" "),v("p",[v("a",{attrs:{"data-fancybox":"",title:"小程序访问统计",href:"/images/20200201totalvisit.png"}},[v("img",{staticStyle:{width:"80%",display:"block"},attrs:{src:"/images/20200210totalvisit.png"}})]),v("br"),t._v(" "),v("a",{attrs:{"data-fancybox":"",title:"小程序访问统计",href:"/images/20200201totalvisit.png"}},[v("img",{staticStyle:{width:"80%",display:"block"},attrs:{src:"/images/20200303totalvisit.png"}})])])])},[],!1,null,null,null);a.default=_.exports}}]);