(window.webpackJsonp=window.webpackJsonp||[]).push([[294],{583:function(t,a,e){"use strict";e.r(a);var s=e(2),r=Object(s.a)({},function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("本文是对上次公众号发文"),e("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=MzI3OTA0NDQ3NQ==&mid=2247484323&idx=1&sn=cb17de96a68aab3c5864d47c693a98a3&chksm=eb4c8bb7dc3b02a1c881b06d667d69b27d6b9b61a6f4841cf9363b8056b0a4e4df04c9388311&token=697353720&lang=zh_CN#rd",target:"_blank",rel:"noopener noreferrer"}},[t._v("《微信小程序逆向源码深度揭秘》"),e("OutboundLink")],1),t._v("的扩展，着重探究小程序包的主要内容构成。"),e("br")]),t._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#先有鸡还是先有蛋？谈谈小程序包的产生与消亡"}},[t._v("先有鸡还是先有蛋？谈谈小程序包的产生与消亡")])]),e("li",[e("a",{attrs:{href:"#包文件结构介绍与打包规则"}},[t._v("包文件结构介绍与打包规则")])]),e("li",[e("a",{attrs:{href:"#得出的一些结论"}},[t._v("得出的一些结论")])]),e("li",[e("a",{attrs:{href:"#参考资料"}},[t._v("参考资料")])])])]),e("p"),t._v(" "),e("h3",{attrs:{id:"先有鸡还是先有蛋？谈谈小程序包的产生与消亡"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#先有鸡还是先有蛋？谈谈小程序包的产生与消亡","aria-hidden":"true"}},[t._v("#")]),t._v(" 先有鸡还是先有蛋？谈谈小程序包的产生与消亡")]),t._v(" "),e("p",[t._v("任何事物都是有生命周期的，小程序包也不例外，为了方便理解，我们暂且叫它【小程序包的生命周期】。其实本没有这个概念，只是为了本文的理解才引入了这么一个概念。"),e("br"),t._v("\n这里大致归纳为以下几个阶段。")]),t._v(" "),e("ul",[e("li",[t._v("产生：苦逼的程序猿们接到领导的需求，火速开发小程序，最后在微信开发者工具中点击【上传】按钮完成小程序包的打包上传，至此一个体验版小程序包(需要后台手动设置版本为体验版)就此在微信的服务器上诞生了。")]),t._v(" "),e("li",[t._v("传播：提交审核通过之后小程序包会被分发到CDN网络，供用户下载。")]),t._v(" "),e("li",[t._v("使用：用户通过某种渠道打开小程序就会把小程序包下载到本地进行解压使用。")]),t._v(" "),e("li",[t._v("归宿：用户们玩腻了在微信主页顶端下拉菜单中长按小程序并拖进垃圾桶。。(最终归于尘土 ಥ_ಥ)")])]),t._v(" "),e("blockquote",[e("p",[t._v("这里需要注意的是：同一小程序分开发版、体验版、正式版，几个包都是独立，互相隔离的，并且缓存(优先加载)在本地。普通用户看到的只是正式版。")])]),t._v(" "),e("h4",{attrs:{id:"用户初次打开小程序时发生了什么"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#用户初次打开小程序时发生了什么","aria-hidden":"true"}},[t._v("#")]),t._v(" 用户初次打开小程序时发生了什么?")]),t._v(" "),e("p",[t._v("在小程序启动时，微信会为小程序展示一个固定的启动界面，界面内包含小程序的图标、名称和加载提示图标。"),e("br"),t._v("\n微信会做以下工作：")]),t._v(" "),e("ul",[e("li",[t._v("下载小程序代码包")]),t._v(" "),e("li",[t._v("加载小程序代码包")]),t._v(" "),e("li",[t._v("初始化小程序首页")])]),t._v(" "),e("h3",{attrs:{id:"包文件结构介绍与打包规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#包文件结构介绍与打包规则","aria-hidden":"true"}},[t._v("#")]),t._v(" 包文件结构介绍与打包规则")]),t._v(" "),e("p",[t._v("关于文件结构这里不再赘述(不是本文关注重点)"),e("br"),t._v("\n这里简要提一下微信小程序包的文件格式，注意是『微信』哦。")]),t._v(" "),e("p",[t._v("格式："),e("br"),t._v(" "),e("strong",[t._v("文件头+文件名+文件内容起始地址及长度")])]),t._v(" "),e("p",[t._v("注意：")]),t._v(" "),e("ul",[e("li",[t._v("微信小程序包文件头信息是以"),e("code",[t._v("0xbe")]),t._v("开头，所以如果你拿了抖音的小程序包来解是没用的")]),t._v(" "),e("li",[t._v("文件内容都是明文存放的，这是我们能够顺利解包的前提")])]),t._v(" "),e("p",[t._v("接着我们回过来来看看解包后文件的主要构成，这里还是拿开源中国的小程序开刀吧🤫😈。"),e("br"),t._v("\n为了辅助理解，我们先修改源码中的 "),e("code",[t._v("wuWxapkg.js")]),t._v(" 文件，L34(34行)后面追加下面的代码")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token template-string"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("`No.")]),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("：`")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" info"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("然后执行以下命令得到日志")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("node wuWxapkg.js -o osc.wxapkg\n")])])]),e("p",[t._v("执行命令后可以在命令行看到包内文件名列表"),e("br"),t._v(" "),e("a",{attrs:{"data-fancybox":"",title:"包内文件名列表",href:"http://cdn.xuedingmiao.com/osc-unpack-list.jpg"}},[e("img",{staticStyle:{width:"90%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/osc-unpack-list.jpg"}})])]),t._v(" "),e("p",[t._v("通过观察文件名列表我们可以看出："),e("br"),t._v("\n包内主要包含"),e("br"),t._v("\n①静态资源->static/**、图片、svg......"),e("br"),t._v("\n②app-config.json"),e("br"),t._v("\n③app-service.js"),e("br"),t._v("\n④page-frame.html"),e("br"),t._v("\n⑤页面html文件->pages/**.html、其它组件或者页面的html")]),t._v(" "),e("p",[t._v("关键文件作用整理如下：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("文件名")]),t._v(" "),e("th",[t._v("作用")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("app-config.json")]),t._v(" "),e("td",[t._v("小程序完整的配置，包含我们通过app.json里的所有配置，综合了默认配置")])]),t._v(" "),e("tr",[e("td",[t._v("app-service.js")]),t._v(" "),e("td",[t._v("各页面的JS代码")])]),t._v(" "),e("tr",[e("td",[t._v("page-frame.html")]),t._v(" "),e("td",[t._v("小程序视图(渲染页面)的模板文件，所有的页面都使用此加载渲染，且所有的WXML都拆解为JS实现打包到这里")])]),t._v(" "),e("tr",[e("td",[t._v("**.html")]),t._v(" "),e("td",[t._v("其它页面的html")])])])]),t._v(" "),e("p",[e("strong",[t._v("主包一般都是2M左右大小，也有特别的会达到4M+")])]),t._v(" "),e("p",[t._v("未列进来的文件：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("文件名")]),t._v(" "),e("th",[t._v("作用")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("WAService.js")]),t._v(" "),e("td",[t._v("逻辑层基础库文件，提供逻辑层基础能力")])]),t._v(" "),e("tr",[e("td",[t._v("WAWebview.js")]),t._v(" "),e("td",[t._v("视图层基础库文件，提供视图层基础能力")])]),t._v(" "),e("tr",[e("td",[t._v("WAConsole.js")]),t._v(" "),e("td",[t._v("控制台基础库")])])])]),t._v(" "),e("p",[t._v("解出来之后如果得到包含这几个文件的内容，就说明解的不是主包。")]),t._v(" "),e("p",[e("strong",[t._v("我们顺带看看微信开发者工具源码中的 pageframe.html")]),e("br"),t._v("\n在mac系统下可以通过『微信开发者工具』上右键菜单点击显示包内容来找到这个模板文件，文件路径：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("/Applications/wechatwebdevtools.app/Contents/Resources/package.nw/html\n")])])]),e("p",[t._v("部分内容一览："),e("br"),t._v(" "),e("a",{attrs:{"data-fancybox":"",title:"pageframe",href:"http://cdn.xuedingmiao.com/pageframe.png"}},[e("img",{staticStyle:{width:"100%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/pageframe.png"}})])]),t._v(" "),e("p",[e("code",[t._v("\x3c!-- --\x3e")]),t._v("部分即是模板字符串，会在执行过程中被动态替换")]),t._v(" "),e("h3",{attrs:{id:"得出的一些结论"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#得出的一些结论","aria-hidden":"true"}},[t._v("#")]),t._v(" 得出的一些结论")]),t._v(" "),e("ul",[e("li",[t._v("基础库是内置在微信客户端的，在用户本地会有缓存，打开小程序时如果本地存在缓存则优先加载，所以如果在开发模式下开启了调试模式没有关闭则打开正式版也会出现绿底白字的『console』悬浮按钮。")]),t._v(" "),e("li",[t._v("微信小程序包的文件头是以 oxbe 开头，所以如果不是则认为不是微信家的小程序包")]),t._v(" "),e("li",[t._v("page-frame.html 是小程序运行时模板文件，所有视图层页面内容的加载都是基于这个模板html文件(从微信开发者工具源码也可以略知一二)进行模板字符串替换")]),t._v(" "),e("li",[t._v("所有的业务逻辑代码都是打包到 app-service.js 文件")])]),t._v(" "),e("p",[t._v("注：以上内容仅是博主学习了相关资料结合个人理解整理所得，不免会有疏漏的地方，如有更好的发现，欢迎交流。")]),t._v(" "),e("h3",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/xuedingmiaojun/wxappUnpacker/blob/master/wuWxapkg.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("wuWxapkg.js"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/xuedingmiaojun/wxappUnpacker/blob/master/DETAILS.md#wxapkg-%E5%8C%85",target:"_blank",rel:"noopener noreferrer"}},[t._v("wxapkg 包"),e("OutboundLink")],1)])])])},[],!1,null,null,null);a.default=r.exports}}]);