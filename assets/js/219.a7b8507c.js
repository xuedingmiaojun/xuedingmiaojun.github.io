(window.webpackJsonp=window.webpackJsonp||[]).push([[219],{505:function(t,e,r){"use strict";r.r(e);var a=r(2),n=Object(a.a)({},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("p",[t._v("最近公司项目需要接入企业微信，所以体验了一把企业微信的对接流程，把对接过程中遇到的问题总结一下。"),r("br")]),t._v(" "),r("p",[r("strong",[t._v("前情提要")]),r("br"),t._v("\n对接之前已经有了基于微信公众号的 H5 应用。需要将 H5 应用接入企业微信(这里应用需要提供给其它企业使用，所以先申请成为了服务商)。")]),t._v(" "),r("p",[t._v("对接流程如下")]),t._v(" "),r("p"),r("div",{staticClass:"table-of-contents"},[r("ul",[r("li",[r("a",{attrs:{href:"#准备工作"}},[t._v("准备工作")])]),r("li",[r("a",{attrs:{href:"#网页应用创建-https-work-weixin-qq-com-api-doc-90001-90142-90595-e5-88-9b-e5-bb-ba-e7-bd-91-e9-a1-b5-e5-ba-94-e7-94-a8"}},[t._v("网页应用创建")])]),r("li",[r("a",{attrs:{href:"#网页应用开发信息配置"}},[t._v("网页应用开发信息配置")])]),r("li",[r("a",{attrs:{href:"#网页应用安装测试"}},[t._v("网页应用安装测试")])]),r("li",[r("a",{attrs:{href:"#应用登录功能接入"}},[t._v("应用登录功能接入")])]),r("li",[r("a",{attrs:{href:"#应用审核-上线-https-work-weixin-qq-com-api-doc-90001-90142-90595-e5-ba-94-e7-94-a8-e4-b8-8a-e7-ba-bf"}},[t._v("应用审核上线")])])])]),r("p"),t._v(" "),r("h3",{attrs:{id:"准备工作"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#准备工作","aria-hidden":"true"}},[t._v("#")]),t._v(" 准备工作")]),t._v(" "),r("ul",[r("li",[t._v("带公网 IP 服务器一台。如果没有则可以选择使用"),r("router-link",{attrs:{to:"/blog/lanproxy.html"}},[t._v("内网穿透工具")]),t._v("进行本地调试。这里博主就是先在本地做的调试。")],1),t._v(" "),r("li",[t._v("开发人员需要成为企业管理员")])]),t._v(" "),r("h3",{attrs:{id:"网页应用创建"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#网页应用创建","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90142/90595#%E5%88%9B%E5%BB%BA%E7%BD%91%E9%A1%B5%E5%BA%94%E7%94%A8",target:"_blank",rel:"noopener noreferrer"}},[t._v("网页应用创建"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("进入"),r("a",{attrs:{href:"https://open.work.weixin.qq.com/wwopen/developer",target:"_blank",rel:"noopener noreferrer"}},[t._v("服务商后台"),r("OutboundLink")],1),t._v("创建应用"),r("br"),t._v("\n应用类型：")]),t._v(" "),r("ul",[r("li",[t._v("普通应用--企业OA、生产流程。有活跃度会被推荐。")]),t._v(" "),r("li",[t._v("通讯录应用--对企业的通讯录拥有根部门的读写权限。一家企业只能授权一个通讯录应用。")])]),t._v(" "),r("p",[t._v("读取手机号需要创建通讯录应用。如果你的应用需要获取用户敏感信息的话，貌似只能选择通讯录类型的应用。")]),t._v(" "),r("h3",{attrs:{id:"网页应用开发信息配置"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#网页应用开发信息配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 网页应用开发信息配置")]),t._v(" "),r("h4",{attrs:{id:"配置内容"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#配置内容","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置内容")]),t._v(" "),r("p",[r("strong",[t._v("使用")])]),t._v(" "),r("ul",[r("li",[t._v("应用主页：用户从企业微信工作台进入应用时会直接跳转到主页URL")]),t._v(" "),r("li",[t._v("可信域名：仅支持可信域名内的应用调用OAuth2授权、JSSDK等")]),t._v(" "),r("li",[t._v("安装完成回调域名：用户安装成功后可指定跳转至该域名的链接")]),t._v(" "),r("li",[t._v("业务设置URL：授权企业的管理员可从企业微信后台的应用详情页免登录直接跳转该链接进行应用配置")])]),t._v(" "),r("p",[r("strong",[t._v("回调")])]),t._v(" "),r("ul",[r("li",[t._v("数据回调URL：用于接收托管企业微信应用的用户消息")]),t._v(" "),r("li",[t._v("指令回调URL：系统将会把此应用的授权变更事件以及ticket参数推送给此URL")]),t._v(" "),r("li",[t._v("Token：用于生成签名校验回调请求的合法性")]),t._v(" "),r("li",[t._v("EncodingAESKey：回调消息加解密参数，是AES密钥的Base64编码，用于解密回调消息内容对应的密文")])]),t._v(" "),r("h4",{attrs:{id:"配置流程"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#配置流程","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置流程")]),t._v(" "),r("p",[t._v("1.可信域名验证。下载验证文件并上传至站点根目录。"),r("br"),t._v("\n2.数据回调与指令回调 url "),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10514#%E9%AA%8C%E8%AF%81URL%E6%9C%89%E6%95%88%E6%80%A7",target:"_blank",rel:"noopener noreferrer"}},[t._v("有效性验证"),r("OutboundLink")],1),r("br"),t._v("\n3.刷新ticket测试"),r("br"),t._v(" "),r("a",{attrs:{"data-fancybox":"",title:"刷新ticket",href:"http://cdn.xuedingmiao.com/refresh-ticket.png"}},[r("img",{staticStyle:{width:"90%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/refresh-ticket.png"}})])]),t._v(" "),r("p",[t._v("在发生授权、通讯录变更、ticket变化等事件时，企业微信服务器会向应用的“指令回调URL”推送相应的事件消息。")]),t._v(" "),r("p",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10982#%E6%8E%A8%E9%80%81suite_ticket",target:"_blank",rel:"noopener noreferrer"}},[t._v("推送suite_ticket"),r("OutboundLink")],1),t._v("。(可以通过手动刷新ticket触发推送)")]),t._v(" "),r("p",[t._v("4.获取第三方应用凭证"),r("br"),t._v("\n根据suite_ticket获取"),r("a",{attrs:{href:"https://open.work.weixin.qq.com/api/doc/10975#%E8%8E%B7%E5%8F%96%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%94%E7%94%A8%E5%87%AD%E8%AF%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("获取第三方应用凭证"),r("OutboundLink")],1),t._v(" suite_access_token")]),t._v(" "),r("h3",{attrs:{id:"网页应用安装测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#网页应用安装测试","aria-hidden":"true"}},[t._v("#")]),t._v(" 网页应用安装测试")]),t._v(" "),r("p",[t._v("服务商可自行授权测试该应用")]),t._v(" "),r("ul",[r("li",[t._v("每个应用目前仅允许10个不同企业微信授权测试")]),t._v(" "),r("li",[t._v("用于测试授权的企业微信，不能再进行正式应用的授权")])]),t._v(" "),r("p",[t._v("1.获取临时授权码auth_code(有效期10分钟)"),r("br"),t._v(" "),r("a",{attrs:{"data-fancybox":"",title:"安装测试",href:"http://cdn.xuedingmiao.com/install-test.png"}},[r("img",{staticStyle:{width:"90%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/install-test.png"}})])]),t._v(" "),r("p",[t._v("点击安装测试进行授权，触发企业微信后台会推送"),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10982#%E6%8E%88%E6%9D%83%E6%88%90%E5%8A%9F%E9%80%9A%E7%9F%A5",target:"_blank",rel:"noopener noreferrer"}},[t._v("授权成功通知"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("2.获取永久授权码(permanent_code)"),r("br"),t._v("\n使用临时授权码"),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10975#%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9A%E6%B0%B8%E4%B9%85%E6%8E%88%E6%9D%83%E7%A0%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("换取授权方的永久授权码"),r("OutboundLink")],1)]),t._v(" "),r("h3",{attrs:{id:"应用登录功能接入"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#应用登录功能接入","aria-hidden":"true"}},[t._v("#")]),t._v(" 应用登录功能接入")]),t._v(" "),r("p",[t._v("1."),r("a",{attrs:{href:"https://open.work.weixin.qq.com/api/doc/10975#%E6%9E%84%E9%80%A0%E7%AC%AC%E4%B8%89%E6%96%B9oauth2%E9%93%BE%E6%8E%A5",target:"_blank",rel:"noopener noreferrer"}},[t._v("构造第三方oauth2链接"),r("OutboundLink")],1),r("br"),t._v("\n构造如下的链接来获取code")]),t._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[t._v("https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect\n")])])]),r("p",[t._v("注：scope 可使用 snsapi_userinfo 。snsapi_privateinfo 并不能获取成员的手机，邮箱。"),r("br"),t._v("\n可以参考下图客服的回答。"),r("br"),t._v(" "),r("a",{attrs:{"data-fancybox":"",title:"客服回答1",href:"http://cdn.xuedingmiao.com/kefu-ans.png"}},[r("img",{staticStyle:{width:"90%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/kefu-ans.png"}})])]),t._v(" "),r("p",[t._v("2.使用 code 换取企业成员 userid"),r("br"),t._v("\n使用第三方应用的suite_access_token及 code "),r("a",{attrs:{href:"https://open.work.weixin.qq.com/api/doc/10975#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A0%B9%E6%8D%AEcode%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9A%E6%88%90%E5%91%98%E4%BF%A1%E6%81%AF",target:"_blank",rel:"noopener noreferrer"}},[t._v("换取企业成员信息"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("3."),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10975#%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9Aaccess_token",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用企业的永久授权码获取企业 access_token"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("4.使用企业成员userid"),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90143/90332",target:"_blank",rel:"noopener noreferrer"}},[t._v("获取成员信息"),r("OutboundLink")],1),t._v("中的手机号"),r("br"),t._v("\n在通讯录同步助手中此接口可以读取企业通讯录的所有成员信息，而自建应用可以读取该应用设置的可见范围内的成员信息。")]),t._v(" "),r("blockquote",[r("p",[t._v("这里如果创建的应用所选应用分类不是通讯录应用的话是无法获取到用户的手机号的。")])]),t._v(" "),r("p",[t._v("5.利用手机号(或者其它信息)做登录")]),t._v(" "),r("h3",{attrs:{id:"应用审核上线"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#应用审核上线","aria-hidden":"true"}},[t._v("#")]),t._v(" 应用审核"),r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90142/90595#%E5%BA%94%E7%94%A8%E4%B8%8A%E7%BA%BF",target:"_blank",rel:"noopener noreferrer"}},[t._v("上线"),r("OutboundLink")],1)]),t._v(" "),r("p",[t._v("已认证企业微信的服务商，可进入应用管理—点击提交上线—勾选应用—提交上线。"),r("br"),t._v('\n企业微信团队会在3个工作日内完成审核，审核结果会通过"企业微信团队"通知服务商管理员。')]),t._v(" "),r("p",[r("a",{attrs:{"data-fancybox":"",title:"提交审核",href:"http://cdn.xuedingmiao.com/review-app.png"}},[r("img",{staticStyle:{width:"100%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/review-app.png"}})])]),t._v(" "),r("p",[t._v("然而，你想的太简单了小盆友。。"),r("br"),t._v("\n可能是运气不好吧，碰上企业微信产品内部策略调整。无法上线。"),r("br"),t._v(" "),r("a",{attrs:{"data-fancybox":"",title:"审核被拒",href:"http://cdn.xuedingmiao.com/qw-app-rejected.png"}},[r("img",{staticStyle:{width:"100%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/qw-app-rejected.png"}})])]),t._v(" "),r("p",[t._v("客服对此的解释："),r("br"),t._v(" "),r("a",{attrs:{"data-fancybox":"",title:"被拒原因",href:"http://cdn.xuedingmiao.com/qw-reason.png"}},[r("img",{staticStyle:{width:"100%",display:"block"},attrs:{src:"http://cdn.xuedingmiao.com/qw-reason.png"}})])]),t._v(" "),r("h4",{attrs:{id:"对接感受"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#对接感受","aria-hidden":"true"}},[t._v("#")]),t._v(" 对接感受")]),t._v(" "),r("p",[t._v("1.企业微信的文档部分信息与实际接口请求返回有出入，文档信息有一定滞后性"),r("br"),t._v("\n2.客服沟通不便，社区内没有解决问题，顺着文档的联系方式找到客服，但是可能需要经历机器人客服->人工客服->技术客服->合作伙伴支持客服->合作伙伴产品客服->腾讯内部其它支持人员。")]),t._v(" "),r("p",[t._v("一般到技术客服那一步就可以解决问题了，但是也存在始终无法解决的情况(需要你更换实现方案)")]),t._v(" "),r("h4",{attrs:{id:"参考资料"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"https://open.work.weixin.qq.com/wwopen/developer",target:"_blank",rel:"noopener noreferrer"}},[t._v("服务商后台"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90142/90595#%E5%88%9B%E5%BB%BA%E7%BD%91%E9%A1%B5%E5%BA%94%E7%94%A8",target:"_blank",rel:"noopener noreferrer"}},[t._v("创建网页应用"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10514#%E9%AA%8C%E8%AF%81URL%E6%9C%89%E6%95%88%E6%80%A7",target:"_blank",rel:"noopener noreferrer"}},[t._v("url 有效性验证"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10982#%E6%8E%A8%E9%80%81suite_ticket",target:"_blank",rel:"noopener noreferrer"}},[t._v("推送suite_ticket"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://open.work.weixin.qq.com/api/doc/10975#%E8%8E%B7%E5%8F%96%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%94%E7%94%A8%E5%87%AD%E8%AF%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("获取第三方应用凭证"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10982#%E6%8E%88%E6%9D%83%E6%88%90%E5%8A%9F%E9%80%9A%E7%9F%A5",target:"_blank",rel:"noopener noreferrer"}},[t._v("授权成功通知"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10975#%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9A%E6%B0%B8%E4%B9%85%E6%8E%88%E6%9D%83%E7%A0%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("换取授权方的永久授权码"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://open.work.weixin.qq.com/api/doc/10975#%E6%9E%84%E9%80%A0%E7%AC%AC%E4%B8%89%E6%96%B9oauth2%E9%93%BE%E6%8E%A5",target:"_blank",rel:"noopener noreferrer"}},[t._v("构造第三方oauth2链接"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://open.work.weixin.qq.com/api/doc/10975#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A0%B9%E6%8D%AEcode%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9A%E6%88%90%E5%91%98%E4%BF%A1%E6%81%AF",target:"_blank",rel:"noopener noreferrer"}},[t._v("code换取企业成员信息"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/10975#%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9Aaccess_token",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用企业的永久授权码获取企业 access_token"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://work.weixin.qq.com/api/doc/90001/90143/90332",target:"_blank",rel:"noopener noreferrer"}},[t._v("获取通讯录成员信息"),r("OutboundLink")],1)]),t._v(" "),r("li",[r("a",{attrs:{href:"https://developers.weixin.qq.com/community/enterprisewechat",target:"_blank",rel:"noopener noreferrer"}},[t._v("企业微信交流专区"),r("OutboundLink")],1)])])])},[],!1,null,null,null);e.default=n.exports}}]);